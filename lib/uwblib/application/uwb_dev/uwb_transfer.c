/************************************************************************************************************
Module:       uwb_transfer

Revision:     1.0

Description:  ---

Notes:        ---

History:
Date          Name      Changes
-----------   ----      -------------------------------------------------------------------------------------
07/13/2022    TH       Began Coding    (TH = Toan Huynh)

COPYRIGHT Â© 2022 TOAN HUYNH. ALL RIGHTS RESERVED.

THIS SOURCE IS TOAN HUYNH PROPRIETARY AND CONFIDENTIAL! NO PART OF THIS
SOURCE MAY BE DISCLOSED IN ANY MANNER TO A THIRD PARTY WITHOUT PRIOR WRITTEN
CONSENT OF TOAN HUYNH.
************************************************************************************************************/

//###########################################################################################################
//      #INCLUDES
//###########################################################################################################
#include "instance.h"
#include "lib.h"
#include "instance_utilities.h"

//###########################################################################################################
//      TESTING #DEFINES
//###########################################################################################################



//###########################################################################################################
//      CONSTANT #DEFINES
//###########################################################################################################



//###########################################################################################################
//      MACROS
//###########################################################################################################



//###########################################################################################################
//      MODULE TYPES
//###########################################################################################################



//###########################################################################################################
//      CONSTANTS
//###########################################################################################################



//###########################################################################################################
//      MODULE LEVEL VARIABLES
//###########################################################################################################



//###########################################################################################################
//      PRIVATE FUNCTION PROTOTYPES
//###########################################################################################################



//###########################################################################################################
//      PUBLIC FUNCTIONS
//###########################################################################################################
/********************************************************************************
Function:
  uwb_send_msg()
Input Parameters:
  ---
Output Parameters:
  ---
Description:
  ---
Notes:
  ---
Author, Date:
  Toan Huynh, 07/12/2022
*********************************************************************************/
bool uwb_send_msg(uint8 *p_msg, uint32 msg_len, uint8 txmode, uint32 dtime)
{
  bool ret = true;

  /* Write the frame data */
  dwt_writetxdata(msg_len, p_msg, 0);
  dwt_writetxfctrl(msg_len, 0, 1);

  if (txmode & DWT_START_TX_DELAYED)
  {
    dwt_setdelayedtrxtime(dtime);
  }

  if (dwt_starttx(txmode))
  {
    ret = false; // late/error
  }

  return ret;
}

/********************************************************************************
Function:
  uwb_get_tx_timeout()
Input Parameters:
  ---
Output Parameters:
  ---
Description:
  Get the TX timeout from tx cmd to tx callback.
Notes:
  ---
Author, Date:
  Toan Huynh, 07/14/2022
*********************************************************************************/
uint32 uwb_get_tx_timeout_ms(uint64 margin_us, uint32 psdu_len)
{
  uint64 framelength_us = instance_getmessageduration_us(psdu_len);
  /* tx cmd to tx cb */
  return (uint32)CEIL_DIV(TX_CMD_TO_TX_CB_DLY_US + framelength_us + margin_us, 1000);
}

//###########################################################################################################
//      PRIVATE FUNCTIONS
//###########################################################################################################


//###########################################################################################################
//      INTERRUPTS
//###########################################################################################################



//###########################################################################################################
//      TEST HARNESSES
//###########################################################################################################



//###########################################################################################################
//      END OF uwb_transfer.c
//###########################################################################################################
